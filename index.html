<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-title" content="SYNTH*BLAST"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
    <meta name="format-detection" content="telephone=no"/>
    <link rel="apple-touch-icon" sizes="150x150" href="assets/img/apple-touch-icon.png">
    <title>SYNTH * BLAST</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            position: fixed;
            /*https://stackoverflow.com/questions/15829172/stop-chrome-back-forward-two-finger-swipe*/
            overscroll-behavior-x: none;
            background-color: #000000;
        }

        canvas {
            width: 100%;
            height: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }

    </style>
</head>
<body>
<script src='js/Facebook.js'></script>
<script src='node_modules/stats.js/build/stats.min.js'></script>
<script src='lib/pixi.min.js'></script>
<script type="module">

    import * as THREE from "./lib/three/build/three.module.js";
    import Game from "./js/classes/Game.js";
    import LevelUi from "./js/classes/ui/LevelUi.js";
    import Menu from "./js/classes/ui/Menu.js";

    // The state we will save and load
    // when making a purchase, this state is sent to the servers,
    // the servers modify and persist the state and a new state is retrieved
    let playerState = {
        activeGame: {
            hp: {
                value: 10,
                max: 10
            },
            shields: {
                value: 0,
                max: 5
            },
            level: 1,
        },
        gamesPlayed: 0,
        highScore: 0,
        coins: 0,
        settings: {
            sound: true,
            music: true
        }
    };

    // Music
    // let implant = new Audio('music/implant-128kbps.mp3');
    let songs = {
        isSongPlaying: false,
        implant: null
    };

    // Sounds
    let audioContext = null;
    let soundsLoaded = false;
    let sounds = {
        pew: new Audio('assets/audio/pip2.wav'),
        point:  new Audio('assets/audio/point.wav'),
        hit: new Audio('assets/audio/hit.wav'),
        explosion: new Audio('assets/audio/explosion2.wav'),
        impact: new Audio('assets/audio/impact.wav'),
        flip: new Audio('assets/audio/flip.wav'),
        shield:  new Audio('assets/audio/shield.wav'),
        launch: new Audio('assets/audio/launch.wav'),
        energy: new Audio('assets/audio/energy2.wav')
    };

    // Renderers
    let rendererThree;
    let rendererPixi;

    let game = null;

    // screens
    let levelUi = null;
    let menuScreen = null;
    let activeScreen = null;

    let frameCount = 0;
    let frameTimes = [];
    let fpsAdjustment = 1;


    // stats
    let stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild(stats.dom);

    init();
    animate();

    function animate() {
        stats.begin();
        rendererThree.state.reset();
        render3d();
        rendererThree.state.reset();

        rendererPixi.reset();
        render2d();
        rendererPixi.reset();

        calculateFps();
        stats.end();
        requestAnimationFrame(animate);
    }

    function init() {
        let canvas = document.getElementById("screen");
        rendererThree = new THREE.WebGLRenderer({
            canvas: canvas
        });
        rendererPixi = new PIXI.Renderer({
            view: canvas,
            context: rendererThree.getContext()
        });

        init3d();
        init2d();

        // listeners
        window.addEventListener('resize', resize, false);
        document.addEventListener('keydown', keyDown, false);
        document.addEventListener('keyup', keyUp, false);
        document.addEventListener('touchstart', touchStart, {passive: false});
        document.addEventListener('touchend', touchEnd, {passive: false});
        document.body.addEventListener('touchmove', touchStart, {passive: false});
        document.addEventListener('mousedown', mouseDown, false);
        document.addEventListener('mouseup', mouseUp, false);
    }

    function init3d() {
        game = new Game(rendererThree, sounds);
    }

    function init2d() {
        let uiCallbacks = {
            pressPlay: pressPlay
        };
        levelUi = new LevelUi(game, rendererPixi, sounds);
        menuScreen = new Menu(game, rendererPixi, sounds, uiCallbacks);
        activeScreen = menuScreen;
    }

    function keyDown(event) {
        if (!audioContext) {
            setAudio();
        }
        activeScreen.onDocumentKeyDown(event);
    }

    function keyUp(event) {
        activeScreen.onDocumentKeyUp(event);
    }

    function touchStart(event) {
        if (!audioContext) {
            setAudio();
        }
        if(sounds && !soundsLoaded) {
            for(let audio of Object.values(sounds)) {
                audio.play();
                audio.pause();
                audio.currentTime = 0;
            }
            soundsLoaded = true;
        }
        activeScreen.touchStart(event);
        event.stopImmediatePropagation();
        event.preventDefault();
    }

    function touchEnd(event) {
        activeScreen.touchEnd(event);
    }

    function mouseDown(event) {
        activeScreen.mouseDown(event);
    }
    function mouseUp(event) {
        activeScreen.mouseUp(event);
    }


    function render3d() {
        game.render(fpsAdjustment);
    }

    function render2d() {
        activeScreen.render();
    }

    function pressPlay() {
        activeScreen = levelUi;
    }

    function resize() {
        game.level.camera.aspect = window.innerWidth / window.innerHeight;
        game.level.camera.updateProjectionMatrix();
        rendererThree.setSize(window.innerWidth, window.innerHeight);
        activeScreen.init();
    }

    function setAudio() {
        // https://stackoverflow.com/questions/9811429/html5-audio-tag-on-safari-has-a-delay
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        if (!songs.isSongPlaying) {
            // songs.implant.currentTime = 0;
            // songs.implant.play();
            // songs.isSongPlaying = true;
        }
    }

    function calculateFps() {
        frameCount++;
        if (frameCount < 10) {
            frameTimes.push((new Date()).getTime());
        } else {
            let frameIndex = frameCount % 10;
            let now = (new Date()).getTime();
            let then = frameTimes[frameIndex];
            frameTimes[frameIndex] = now;
            let fps = 10.0 / ((now - then) / 1000);
            if (fps > 1) {
                fpsAdjustment = 60 / fps;
            }
        }
    }


</script>
<canvas id="screen"></canvas>
</body>
</html>
