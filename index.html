<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-title" content="SYNTH*BLAST"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
    <meta name="format-detection" content="telephone=no"/>
    <link rel="apple-touch-icon" sizes="150x150" href="assets/img/apple-touch-icon.png">
    <title>SYNTH * BLAST</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            position: fixed;
            /*https://stackoverflow.com/questions/15829172/stop-chrome-back-forward-two-finger-swipe*/
            overscroll-behavior-x: none;
            background-color: #000000;
        }

        canvas {
            width: 100%;
            height: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
        }

    </style>
</head>
<body>
<script src='js/Facebook.js'></script>
<script src='node_modules/stats.js/build/stats.min.js'></script>
<script src='lib/pixi.min.js'></script>
<script type="module">

    import * as THREE from "./lib/three/build/three.module.js";
    import Game from "./js/classes/Game.js";
    import LevelUi from "./js/classes/ui/LevelUi.js";

    // The state we will save and load
    // when making a purchase, this state is sent to the servers,
    // the servers modify and persist the state and a new state is retrieved
    let playerState = {
        activeGame: {
            hp: {
                value: 10,
                max: 10
            },
            shields: {
                value: 0,
                max: 5
            },
            level: 1,
        },
        gamesPlayed: 0,
        highScore: 0,
        coins: 0
    };

    // Music
    // let implant = new Audio('music/implant-128kbps.mp3');
    let songs = {
        isSongPlaying: false,
        implant: null
    };

    // Sounds
    let audioContext = null;
    // let massive = new Audio('assets/audio/massive2.wav');
    let pew = new Audio('assets/audio/pip2.wav');
    let pointSound = new Audio('assets/audio/point.wav');
    let hitSound = new Audio('assets/audio/hit.wav');
    let explosionSound = new Audio('assets/audio/explosion2.wav');
    let impactSound = new Audio('assets/audio/impact.wav');
    let flipSound = new Audio('assets/audio/flip.wav');
    let shieldSound = new Audio('assets/audio/shield.wav');
    let launchSound = new Audio('assets/audio/launch.wav');
    let energySound = new Audio('assets/audio/energy2.wav');
    let sounds = {
        pew: pew,
        point: pointSound,
        hit: hitSound,
        explosion: explosionSound,
        impact: impactSound,
        flip: flipSound,
        shield: shieldSound,
        launch: launchSound,
        energy: energySound
    };

    // Renderers
    let rendererThree;
    let rendererPixi;

    let levelUi = null;
    let game = null;

    let frameCount = 0;
    let frameTimes = [];
    let fpsAdjustment = 1;


    // stats
    let stats = new Stats();
    stats.showPanel(0); // 0: fps, 1: ms, 2: mb, 3+: custom
    document.body.appendChild(stats.dom);

    init();
    animate();

    function animate() {
        stats.begin();
        rendererThree.state.reset();
        render3d();
        rendererThree.state.reset();

        rendererPixi.reset();
        render2d();
        rendererPixi.reset();

        calculateFps();
        stats.end();
        requestAnimationFrame(animate);
    }

    function init() {
        let canvas = document.getElementById("screen");
        rendererThree = new THREE.WebGLRenderer({
            canvas: canvas
        });
        rendererPixi = new PIXI.Renderer({
            view: canvas,
            context: rendererThree.getContext()
        });

        init3d();
        init2d();

        // listeners
        window.addEventListener('resize', onWindowResize, false);
        document.addEventListener('keydown', onDocumentKeyDown, false);
        document.addEventListener('keyup', onDocumentKeyUp, false);
        document.addEventListener('touchstart', touchStart, {passive: false});
        document.addEventListener('touchend', touchEnd, {passive: false});
        document.body.addEventListener('touchmove', touchStart, {passive: false});
    }

    function onDocumentKeyDown(event) {
        if (!audioContext) {
            setAudio();
        }
        levelUi.onDocumentKeyDown(event);
    }

    function onDocumentKeyUp(event) {
        levelUi.onDocumentKeyUp(event);
    }

    function touchStart(event) {
        if (!audioContext) {
            setAudio();
        }
        levelUi.touchStart(event);
    }

    function touchEnd(event) {
        levelUi.touchEnd(event);
    }

    function init3d() {
        game = new Game(rendererThree, sounds);
    }

    function init2d() {
        levelUi = new LevelUi(game, rendererPixi, sounds);
    }

    function render3d() {
        game.render(fpsAdjustment);
    }

    function render2d() {
        levelUi.render();
    }

    function onWindowResize() {
        game.level.camera.aspect = window.innerWidth / window.innerHeight;
        game.level.camera.updateProjectionMatrix();
        rendererThree.setSize(window.innerWidth, window.innerHeight);
        levelUi.init();
    }

    function setAudio() {
        // https://stackoverflow.com/questions/9811429/html5-audio-tag-on-safari-has-a-delay
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();

        if (!songs.isSongPlaying) {
            // songs.implant.currentTime = 0;
            // songs.implant.play();
            // songs.isSongPlaying = true;
        }
    }

    function calculateFps() {
        frameCount++;
        if (frameCount < 10) {
            frameTimes.push((new Date()).getTime());
        } else {
            let frameIndex = frameCount % 10;
            let now = (new Date()).getTime();
            let then = frameTimes[frameIndex];
            frameTimes[frameIndex] = now;
            let fps = 10.0 / ((now - then) / 1000);
            if (fps > 1) {
                fpsAdjustment = 60 / fps;
            }
        }
    }


</script>
<canvas id="screen"></canvas>
</body>
</html>
